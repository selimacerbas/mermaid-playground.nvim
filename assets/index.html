<!doctype html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Markdown Preview</title>

    <!-- highlight.js theme (swapped dynamically for light mode) -->
    <link id="hljs-theme" rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css" />

    <style>
        /* ── CSS Variables ─────────────────────────────────────────────── */
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --stroke: #30363d;
            --fg: #e6edf3;
            --fg-muted: #8b949e;
            --link: #58a6ff;
            --code-bg: #1b2028;
            --blockquote-border: #3b434b;
            --table-border: #30363d;
            --table-row-alt: rgba(255, 255, 255, .03);
            --err-bg: rgba(239, 68, 68, .12);
            --err-border: rgba(239, 68, 68, .35);
            --err-fg: #fecaca;
            --scroll-track: transparent;
            --scroll-thumb: rgba(148, 163, 184, .35);
            --scroll-thumb-hover: rgba(148, 163, 184, .6);
            --accent: #58a6ff;
            --badge-bg: rgba(255, 255, 255, .06);
            --badge-fg: #8b949e;
            --skeleton: rgba(255, 255, 255, .04);
            --skeleton-shine: rgba(255, 255, 255, .08);
        }

        [data-theme="light"] {
            --bg: #ffffff;
            --panel: #f6f8fa;
            --stroke: #d0d7de;
            --fg: #1f2328;
            --fg-muted: #656d76;
            --link: #0969da;
            --code-bg: #f6f8fa;
            --blockquote-border: #d0d7de;
            --table-border: #d0d7de;
            --table-row-alt: rgba(0, 0, 0, .02);
            --err-bg: rgba(239, 68, 68, .08);
            --err-border: #fecaca;
            --err-fg: #7f1d1d;
            --scroll-track: transparent;
            --scroll-thumb: rgba(100, 116, 139, .4);
            --scroll-thumb-hover: rgba(100, 116, 139, .65);
            --accent: #0969da;
            --badge-bg: rgba(0, 0, 0, .04);
            --badge-fg: #656d76;
            --skeleton: rgba(0, 0, 0, .04);
            --skeleton-shine: rgba(0, 0, 0, .07);
        }

        /* ── Reset & base ──────────────────────────────────────────────── */
        *,
        *::before,
        *::after {
            box-sizing: border-box
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Header ────────────────────────────────────────────────────── */
        header {
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .55rem 1.2rem;
            background: var(--panel);
            border-bottom: 1px solid var(--stroke);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        header h1 {
            margin: 0;
            font-size: .9rem;
            font-weight: 600;
            letter-spacing: .2px;
        }

        .header-icon {
            display: flex;
            align-items: center;
            color: var(--fg-muted);
        }

        .spacer {
            flex: 1
        }

        /* Connection dot */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--fg-muted);
            opacity: .4;
            transition: all .3s;
            flex-shrink: 0;
        }

        .status-dot.connected {
            background: #3fb950;
            opacity: 1;
            box-shadow: 0 0 6px rgba(63, 185, 80, .5);
        }

        .status-dot.error {
            background: #f85149;
            opacity: 1;
        }

        #status {
            font-size: .75rem;
            color: var(--fg-muted);
        }

        .btn {
            background: transparent;
            border: 1px solid var(--stroke);
            color: var(--fg-muted);
            padding: .35rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: .82rem;
            font-weight: 500;
            transition: border-color .15s, background .15s, color .15s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .btn:hover {
            background: rgba(127, 127, 127, .1);
            color: var(--fg);
        }

        .btn-text {
            width: auto;
            padding: .35rem .65rem;
        }

        /* ── Loading skeleton ─────────────────────────────────────────── */
        .skeleton {
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .skeleton-line {
            height: 14px;
            border-radius: 6px;
            background: var(--skeleton);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .skeleton-line::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, var(--skeleton-shine), transparent);
            animation: shimmer 1.5s infinite;
        }

        .skeleton-line:nth-child(1) {
            width: 45%;
            height: 28px;
            margin-bottom: 20px;
        }

        .skeleton-line:nth-child(2) {
            width: 90%
        }

        .skeleton-line:nth-child(3) {
            width: 75%
        }

        .skeleton-line:nth-child(4) {
            width: 85%
        }

        .skeleton-line:nth-child(5) {
            width: 60%
        }

        .skeleton-line:nth-child(6) {
            width: 0;
            height: 8px
        }

        .skeleton-line:nth-child(7) {
            width: 35%;
            height: 22px;
            margin-bottom: 16px
        }

        .skeleton-line:nth-child(8) {
            width: 80%
        }

        .skeleton-line:nth-child(9) {
            width: 70%
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%)
            }

            100% {
                transform: translateX(100%)
            }
        }

        /* ── Markdown content ──────────────────────────────────────────── */
        #content {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 2rem 4rem;
            animation: fadeIn .2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        #content>*:first-child {
            margin-top: 0
        }

        /* Headings */
        #content h1 {
            font-size: 2em;
            border-bottom: 1px solid var(--stroke);
            padding-bottom: .3em;
            margin: 1.5em 0 .5em;
        }

        #content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--stroke);
            padding-bottom: .25em;
            margin: 1.4em 0 .5em;
        }

        #content h3 {
            font-size: 1.25em;
            margin: 1.3em 0 .4em;
        }

        #content h4 {
            font-size: 1em;
            margin: 1.2em 0 .4em;
        }

        #content h5,
        #content h6 {
            font-size: .875em;
            color: var(--fg-muted);
            margin: 1em 0 .4em;
        }

        /* Paragraphs & text */
        #content p {
            margin: 0 0 1em;
        }

        #content a {
            color: var(--link);
            text-decoration: none;
        }

        #content a:hover {
            text-decoration: underline;
        }

        #content strong {
            font-weight: 600
        }

        #content img {
            max-width: 100%;
            border-radius: 6px;
        }

        #content hr {
            height: 3px;
            background: var(--stroke);
            border: none;
            margin: 1.5em 0;
        }

        /* Lists */
        #content ul,
        #content ol {
            padding-left: 2em;
            margin: 0 0 1em;
        }

        #content li+li {
            margin-top: .25em
        }

        /* Task lists */
        #content .task-list-item {
            list-style: none;
            margin-left: -1.5em;
        }

        #content .task-list-item input[type="checkbox"] {
            margin-right: .4em;
        }

        /* Blockquotes */
        #content blockquote {
            margin: 0 0 1em;
            padding: .5em 1em;
            border-left: 4px solid var(--blockquote-border);
            color: var(--fg-muted);
        }

        #content blockquote>*:last-child {
            margin-bottom: 0
        }

        /* Tables */
        #content table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 0 1em;
            font-size: .9em;
        }

        #content th,
        #content td {
            padding: .5em .8em;
            border: 1px solid var(--table-border);
        }

        #content th {
            background: var(--panel);
            font-weight: 600;
        }

        #content tr:nth-child(even) {
            background: var(--table-row-alt);
        }

        /* Inline code */
        #content code {
            background: var(--code-bg);
            padding: .15em .35em;
            border-radius: 4px;
            font-size: .88em;
            font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
        }

        /* Code blocks */
        #content pre {
            position: relative;
            background: var(--code-bg);
            border: 1px solid var(--stroke);
            border-radius: 8px;
            padding: 1em;
            overflow-x: auto;
            margin: 0 0 1em;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) transparent;
        }

        #content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: .85em;
            line-height: 1.55;
        }

        /* Language badge on code blocks */
        #content pre[data-lang]::before {
            content: attr(data-lang);
            position: absolute;
            top: 0;
            right: 0;
            padding: .2em .6em;
            font-size: .68rem;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--badge-fg);
            background: var(--badge-bg);
            border-bottom-left-radius: 6px;
            border-top-right-radius: 7px;
            text-transform: uppercase;
            letter-spacing: .5px;
            font-weight: 500;
            line-height: 1.4;
        }

        /* ── Mermaid diagrams ──────────────────────────────────────────── */
        .mermaid-block {
            position: relative;
            margin: 1em 0;
            border: 1px solid var(--stroke);
            border-radius: 10px;
            background: var(--panel);
            overflow: hidden;
            min-height: 60px;
        }

        .mermaid-block .mermaid-svg-wrap {
            padding: 1rem;
            display: flex;
            justify-content: center;
            overflow: auto;
        }

        .mermaid-block .mermaid-svg-wrap svg {
            max-width: 100%;
            height: auto;
        }

        .mermaid-block .mermaid-expand-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 2;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity .2s;
            color: var(--fg-muted);
        }

        .mermaid-block:hover .mermaid-expand-btn {
            opacity: 1
        }

        .mermaid-block .mermaid-expand-btn:hover {
            color: var(--fg);
            background: rgba(127, 127, 127, .1);
        }

        .mermaid-block .mermaid-error {
            padding: .6rem 1rem;
            font-size: .85rem;
            color: var(--err-fg);
            background: var(--err-bg);
            border: 1px solid var(--err-border);
            border-radius: 6px;
            margin: .5rem;
        }

        /* Hide Mermaid's built-in error artifacts (NOT .messageText — used for sequence diagram labels) */
        .mermaid-block :where(.error, .error-icon, .error-text, .errorText) {
            display: none !important
        }

        /* ── Fullscreen overlay (mermaid zoom/pan) ─────────────────────── */
        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: var(--bg);
            flex-direction: column;
        }

        #overlay.active {
            display: flex
        }

        #overlay-toolbar {
            display: flex;
            gap: .4rem;
            align-items: center;
            padding: .5rem 1rem;
            background: var(--panel);
            border-bottom: 1px solid var(--stroke);
            flex-wrap: wrap;
        }

        #overlay-toolbar .sep {
            width: 1px;
            height: 24px;
            background: var(--stroke);
            margin: 0 .2rem;
        }

        #overlay-toolbar .grow {
            flex: 1
        }

        #overlay-panzoom {
            flex: 1;
            overflow: auto;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-thumb) var(--scroll-track);
        }

        #overlay-panzoom.dragging {
            cursor: grabbing
        }

        #overlay-panzoom svg {
            display: block
        }

        /* ── Misc ──────────────────────────────────────────────────────── */
        @media (max-width: 768px) {
            #content {
                padding: 1rem 1rem 3rem
            }
        }
    </style>
</head>

<body>
    <header>
        <span class="header-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="1.5" />
                <path d="M7 15V9l2.5 3L12 9v6M16 12l2-3 2 3M16 12h4" stroke="currentColor" stroke-width="1.5"
                    stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </span>
        <h1>Markdown Preview</h1>
        <div class="spacer"></div>
        <div id="statusDot" class="status-dot" title="Disconnected"></div>
        <span id="status" aria-live="polite"></span>
        <button id="themeBtn" class="btn" title="Toggle light/dark">
            <svg id="themeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path id="moonPath"
                    d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </button>
    </header>

    <!-- Loading skeleton (replaced by content) -->
    <div id="loadingSkeleton" class="skeleton">
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
    </div>

    <div id="content" style="display:none"></div>

    <!-- Fullscreen overlay for diagram zoom/pan -->
    <div id="overlay">
        <div id="overlay-toolbar">
            <span style="font-weight:600;font-size:.9rem">Diagram</span>
            <div class="sep"></div>
            <span style="font-size:.82rem;color:var(--fg-muted)">Zoom:</span>
            <button id="ovZoomOut" class="btn" title="Zoom out">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button id="ovZoomReset" class="btn btn-text" title="Reset zoom" style="font-size:.78rem">100%</button>
            <button id="ovZoomIn" class="btn" title="Zoom in">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div class="sep"></div>
            <button id="ovFitWidth" class="btn btn-text" title="Fit to width" style="font-size:.78rem">Fit width</button>
            <button id="ovFitHeight" class="btn btn-text" title="Fit height" style="font-size:.78rem">Fit height</button>
            <div class="grow"></div>
            <button id="ovExport" class="btn btn-text" title="Export SVG" style="font-size:.78rem">Export SVG</button>
            <button id="ovClose" class="btn" title="Close (Esc)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
        </div>
        <div id="overlay-panzoom"></div>
    </div>

    <!-- CDN deps: markdown-it, morphdom, highlight.js (browser build) -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/morphdom@2/dist/morphdom-umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        // ── DOM refs ──────────────────────────────────────────────────
        const $ = (id) => document.getElementById(id);
        const contentEl = $('content');
        const statusEl = $('status');
        const themeBtn = $('themeBtn');
        const statusDot = $('statusDot');
        const loadingSkeleton = $('loadingSkeleton');

        // Overlay refs
        const overlay = $('overlay');
        const overlayPanzoom = $('overlay-panzoom');
        const ovZoomIn = $('ovZoomIn');
        const ovZoomOut = $('ovZoomOut');
        const ovZoomReset = $('ovZoomReset');
        const ovFitWidth = $('ovFitWidth');
        const ovFitHeight = $('ovFitHeight');
        const ovExport = $('ovExport');
        const ovClose = $('ovClose');

        // SVG paths for theme icons
        const MOON_SVG = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>';
        const SUN_SVG = '<circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>';

        // ── State ─────────────────────────────────────────────────────
        let lastContent = null;
        let currentTheme = 'dark';
        let mermaidIdCounter = 0;
        let sseConnected = false;
        const loadedPacks = new Set();

        // Overlay state
        let ovSvgSource = '';
        let ovBaseW = 0, ovBaseH = 0;
        let ovZoom = 1;
        let ovFitMode = 'width';
        let ovDragging = false, ovStartX = 0, ovStartY = 0, ovStartL = 0, ovStartT = 0;

        const setStatus = (t) => { if (statusEl) statusEl.textContent = t || ''; };
        const nowTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        function setConnectionState(state) {
            statusDot.className = 'status-dot' + (state === 'connected' ? ' connected' : state === 'error' ? ' error' : '');
            statusDot.title = state === 'connected' ? 'Connected' : state === 'error' ? 'Disconnected' : 'Connecting...';
        }

        function showContent() {
            if (loadingSkeleton) loadingSkeleton.style.display = 'none';
            contentEl.style.display = '';
        }

        // ── Theme ─────────────────────────────────────────────────────
        function applyTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            const themeIcon = $('themeIcon');
            if (themeIcon) themeIcon.innerHTML = theme === 'dark' ? MOON_SVG : SUN_SVG;
            const hljsLink = $('hljs-theme');
            if (hljsLink) {
                hljsLink.href = theme === 'dark'
                    ? 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css'
                    : 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github.min.css';
            }
            mermaid.initialize({
                startOnLoad: false,
                theme: theme === 'dark' ? 'dark' : 'default',
                securityLevel: 'strict',
            });
        }

        themeBtn.addEventListener('click', () => {
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            renderAllMermaidBlocks();
        });

        // ── Markdown-it setup ─────────────────────────────────────────
        if (!window.markdownit) {
            console.error('[markdown-preview] markdown-it not loaded from CDN');
            showContent();
            contentEl.innerHTML = '<p style="color:var(--err-fg)">Failed to load markdown-it from CDN. Check your internet connection.</p>';
        }
        const md = (window.markdownit || function () { return { render: (t) => '<pre>' + t + '</pre>', utils: { escapeHtml: (s) => s } }; })({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && lang.toLowerCase() === 'mermaid') {
                    const encoded = encodeURIComponent(str);
                    return `<div class="mermaid-block" data-mermaid-source="${encoded}"><div class="mermaid-svg-wrap"><p style="color:var(--fg-muted);font-size:.85rem">Rendering diagram&hellip;</p></div></div>`;
                }
                if (lang && window.hljs && window.hljs.getLanguage(lang)) {
                    try {
                        return '<pre class="hljs" data-lang="' + md.utils.escapeHtml(lang) + '"><code>' +
                            window.hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                            '</code></pre>';
                    } catch (_) { }
                }
                const langAttr = lang ? ' data-lang="' + md.utils.escapeHtml(lang) + '"' : '';
                return '<pre class="hljs"' + langAttr + '><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        // Override fence renderer to handle mermaid specially
        const defaultFence = md.renderer.rules.fence;
        md.renderer.rules.fence = function (tokens, idx, options, env, self) {
            const token = tokens[idx];
            const info = token.info ? token.info.trim().toLowerCase() : '';
            if (info === 'mermaid') {
                const encoded = encodeURIComponent(token.content);
                const stableId = 'mmd-' + idx;
                return `<div class="mermaid-block" id="${stableId}" data-mermaid-source="${encoded}" data-graph="mermaid">` +
                    `<button class="mermaid-expand-btn" title="Expand diagram" data-expand="${stableId}">` +
                    `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>` +
                    `</button>` +
                    `<div class="mermaid-svg-wrap"><p style="color:var(--fg-muted);font-size:.85rem">Rendering&hellip;</p></div>` +
                    `</div>`;
            }
            if (defaultFence) return defaultFence(tokens, idx, options, env, self);
            return self.renderToken(tokens, idx, options);
        };

        // ── Iconify auto-detection ────────────────────────────────────
        function detectPacks(src) {
            const re = /\b([a-z0-9-]+):[a-z0-9-]+\b/gi;
            const s = new Set();
            let m;
            while ((m = re.exec(src))) s.add(m[1].toLowerCase());
            return [...s];
        }

        async function ensurePack(name) {
            if (loadedPacks.has(name)) return;
            try {
                const loader = () => fetch(`https://unpkg.com/@iconify-json/${name}@1/icons.json`).then(r => r.json());
                await mermaid.registerIconPacks([{ name, loader }]);
                loadedPacks.add(name);
            } catch (_) { }
        }

        // ── Mermaid rendering ─────────────────────────────────────────
        const lastGoodSvg = {};

        async function renderMermaidBlock(block) {
            const source = decodeURIComponent(block.dataset.mermaidSource || '');
            if (!source.trim()) return;

            const wrap = block.querySelector('.mermaid-svg-wrap');
            if (!wrap) return;

            const packs = detectPacks(source);
            for (const p of packs) await ensurePack(p);

            try {
                mermaidIdCounter++;
                const id = 'mmd-render-' + mermaidIdCounter;
                const { svg } = await mermaid.render(id, source);

                wrap.innerHTML = svg;
                block.classList.add('mermaid-rendered');
                block.classList.remove('mermaid-errored');
                lastGoodSvg[block.id] = svg;

                block.querySelectorAll('.error,.error-icon,.error-text,.errorText').forEach(n => n.remove());
            } catch (e) {
                block.classList.add('mermaid-errored');
                const fallback = lastGoodSvg[block.id];
                if (fallback) {
                    wrap.innerHTML = fallback;
                }
                let errEl = block.querySelector('.mermaid-error');
                if (!errEl) {
                    errEl = document.createElement('div');
                    errEl.className = 'mermaid-error';
                    block.appendChild(errEl);
                }
                const msg = String(e?.message || e || 'Invalid diagram')
                    .split('\n').find(Boolean) || 'Invalid diagram';
                errEl.textContent = msg.replace(/\s*mermaid version\s*\d+(?:\.\d+)*\s*$/i, '').trim();

                block.querySelectorAll('.error,.error-icon,.error-text,.errorText').forEach(n => n.remove());
            }
        }

        async function renderAllMermaidBlocks() {
            const blocks = contentEl.querySelectorAll('.mermaid-block[data-mermaid-source]');
            for (const block of blocks) {
                await renderMermaidBlock(block);
            }
        }

        // ── Content sync ──────────────────────────────────────────────
        async function fetchContent() {
            try {
                const resp = await fetch('content.md?ts=' + Date.now(), { cache: 'no-store' });
                if (!resp.ok) {
                    console.warn('[markdown-preview] content.md fetch failed:', resp.status);
                    return null;
                }
                return (await resp.text()).replace(/\r\n?/g, '\n');
            } catch (e) {
                console.warn('[markdown-preview] content.md fetch error:', e);
                return null;
            }
        }

        async function sync(initial = false) {
            const text = await fetchContent();
            if (text == null) {
                if (initial) setStatus('Waiting for content...');
                return;
            }
            if (!initial && text === lastContent) return;
            lastContent = text;

            try {
                const html = md.render(text);

                showContent();

                if (window.morphdom) {
                    const wrapper = document.createElement('div');
                    wrapper.id = 'content';
                    wrapper.innerHTML = html;

                    window.morphdom(contentEl, wrapper, {
                        childrenOnly: false,
                        getNodeKey: function (node) {
                            if (node.nodeType === 1) {
                                if (node.getAttribute && node.getAttribute('data-graph') === 'mermaid') {
                                    return node.id;
                                }
                                return node.id || null;
                            }
                            return null;
                        },
                        onBeforeElUpdated: function (fromEl, toEl) {
                            if (fromEl.classList && fromEl.classList.contains('mermaid-rendered') &&
                                fromEl.dataset.mermaidSource === toEl.dataset.mermaidSource) {
                                return false;
                            }
                            if (fromEl.tagName === 'DETAILS' && fromEl.hasAttribute('open')) {
                                toEl.setAttribute('open', '');
                            }
                            return true;
                        },
                    });
                } else {
                    contentEl.innerHTML = html;
                }

                const blocks = contentEl.querySelectorAll('.mermaid-block[data-mermaid-source]:not(.mermaid-rendered)');
                for (const block of blocks) {
                    await renderMermaidBlock(block);
                }

                setStatus('Updated ' + nowTime());
            } catch (e) {
                console.error('[markdown-preview] render error:', e);
                contentEl.innerHTML = '<pre style="white-space:pre-wrap;padding:1rem">' +
                    text.replace(/&/g, '&amp;').replace(/</g, '&lt;') + '</pre>';
                setStatus('Render error: ' + e.message);
            }
        }

        // ── SSE (Server-Sent Events from live-server.nvim) ────────────
        function connectSSE() {
            const evtSource = new EventSource('/__live/events');
            evtSource.addEventListener('reload', async () => {
                await sync(false);
            });
            evtSource.addEventListener('open', () => {
                console.log('[markdown-preview] SSE connected');
                sseConnected = true;
                setConnectionState('connected');
            });
            evtSource.addEventListener('error', () => {
                sseConnected = false;
                setConnectionState('error');
            });
            return evtSource;
        }

        // ── Expand overlay (fullscreen diagram zoom/pan) ──────────────
        function openOverlay(svgHtml) {
            ovSvgSource = svgHtml;
            overlayPanzoom.innerHTML = svgHtml;
            overlay.classList.add('active');

            const svg = overlayPanzoom.querySelector('svg');
            if (svg) {
                const vb = svg.getAttribute('viewBox');
                if (vb) {
                    const parts = vb.trim().split(/\s+/).map(Number);
                    if (parts.length === 4) { ovBaseW = parts[2]; ovBaseH = parts[3]; }
                } else {
                    ovBaseW = parseFloat(svg.getAttribute('width')) || 800;
                    ovBaseH = parseFloat(svg.getAttribute('height')) || 600;
                }
            }

            ovZoom = 1;
            ovFitMode = 'width';
            updateOverlayFit();
            updateOverlayFitBtns();
        }

        function closeOverlay() {
            overlay.classList.remove('active');
            overlayPanzoom.innerHTML = '';
        }

        function applyOverlayZoom() {
            const svg = overlayPanzoom.querySelector('svg');
            if (!svg || !ovBaseW || !ovBaseH) return;
            svg.removeAttribute('style');
            svg.removeAttribute('width');
            svg.removeAttribute('height');
            svg.setAttribute('width', String(Math.max(1, Math.round(ovBaseW * ovZoom))));
            svg.setAttribute('height', String(Math.max(1, Math.round(ovBaseH * ovZoom))));
            ovZoomReset.textContent = Math.round(ovZoom * 100) + '%';
        }

        function updateOverlayFit() {
            if (!ovBaseW || !ovBaseH) return;
            const cw = overlayPanzoom.clientWidth || ovBaseW;
            const ch = overlayPanzoom.clientHeight || ovBaseH;
            if (ovFitMode === 'width') ovZoom = cw / ovBaseW;
            else if (ovFitMode === 'height') ovZoom = ch / ovBaseH;
            ovZoom = Math.min(8, Math.max(0.1, ovZoom));
            applyOverlayZoom();
        }

        function updateOverlayFitBtns() {
            ovFitWidth.style.borderColor = ovFitMode === 'width' ? 'var(--accent)' : '';
            ovFitHeight.style.borderColor = ovFitMode === 'height' ? 'var(--accent)' : '';
        }

        ovZoomIn.addEventListener('click', () => { ovFitMode = 'none'; ovZoom *= 1.2; applyOverlayZoom(); updateOverlayFitBtns(); });
        ovZoomOut.addEventListener('click', () => { ovFitMode = 'none'; ovZoom /= 1.2; applyOverlayZoom(); updateOverlayFitBtns(); });
        ovZoomReset.addEventListener('click', () => { ovFitMode = 'none'; ovZoom = 1; applyOverlayZoom(); updateOverlayFitBtns(); });
        ovFitWidth.addEventListener('click', () => { ovFitMode = ovFitMode === 'width' ? 'none' : 'width'; updateOverlayFit(); updateOverlayFitBtns(); });
        ovFitHeight.addEventListener('click', () => { ovFitMode = ovFitMode === 'height' ? 'none' : 'height'; updateOverlayFit(); updateOverlayFitBtns(); });

        // Overlay pan (drag)
        overlayPanzoom.addEventListener('mousedown', (e) => {
            ovDragging = true; overlayPanzoom.classList.add('dragging');
            ovStartX = e.clientX; ovStartY = e.clientY;
            ovStartL = overlayPanzoom.scrollLeft; ovStartT = overlayPanzoom.scrollTop;
        });
        window.addEventListener('mousemove', (e) => {
            if (!ovDragging) return;
            overlayPanzoom.scrollLeft = ovStartL - (e.clientX - ovStartX);
            overlayPanzoom.scrollTop = ovStartT - (e.clientY - ovStartY);
        });
        window.addEventListener('mouseup', () => { ovDragging = false; overlayPanzoom.classList.remove('dragging'); });

        // Overlay wheel zoom
        overlayPanzoom.addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                ovFitMode = 'none';
                ovZoom *= e.deltaY > 0 ? (1 / 1.1) : 1.1;
                applyOverlayZoom();
                updateOverlayFitBtns();
            }
        }, { passive: false });

        // Export SVG from overlay
        ovExport.addEventListener('click', () => {
            if (!ovSvgSource) return;
            const blob = new Blob([ovSvgSource], { type: 'image/svg+xml' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'diagram.svg';
            a.click();
            setTimeout(() => URL.revokeObjectURL(a.href), 2000);
        });

        // Close overlay
        ovClose.addEventListener('click', closeOverlay);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && overlay.classList.contains('active')) {
                closeOverlay();
            }
        });

        // Resize handler for overlay fit
        let ovResizeTimer = null;
        window.addEventListener('resize', () => {
            clearTimeout(ovResizeTimer);
            ovResizeTimer = setTimeout(() => {
                if (overlay.classList.contains('active') && ovFitMode !== 'none') {
                    updateOverlayFit();
                }
            }, 80);
        });

        // ── Event delegation for expand buttons ───────────────────────
        contentEl.addEventListener('click', (e) => {
            const expandBtn = e.target.closest('[data-expand]');
            if (!expandBtn) return;
            const blockId = expandBtn.dataset.expand;
            const block = document.getElementById(blockId);
            if (!block) return;
            const wrap = block.querySelector('.mermaid-svg-wrap');
            if (!wrap) return;
            const svg = wrap.innerHTML;
            if (svg) openOverlay(svg);
        });

        // ── Boot ──────────────────────────────────────────────────────
        (async function boot() {
            try {
                applyTheme('dark');
                await sync(true);
            } catch (e) {
                console.error('[markdown-preview] boot error:', e);
                showContent();
                contentEl.innerHTML = '<p style="color:var(--err-fg)">Error: ' + (e.message || e) + '</p>';
            }
            connectSSE();
        })();
    </script>

    <noscript>
        <p style="padding:1rem;color:#fff;background:#7f1d1d">
            This page requires JavaScript to render Markdown and Mermaid diagrams.
        </p>
    </noscript>
</body>

</html>
