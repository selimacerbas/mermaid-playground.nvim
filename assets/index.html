<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mermaid Architecture Preview</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #0f172a;
            --stroke: #1f2937;
            --fg: #e5e7eb;
            --muted: #9ca3af;
            --err-bg: rgba(239, 68, 68, .12);
            --err-border: rgba(239, 68, 68, .35);
            --err-fg: #fecaca
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
        }

        header {
            padding: .9rem 1rem;
            display: flex;
            gap: .5rem;
            align-items: center;
            border-bottom: 1px solid var(--stroke);
            background: rgba(255, 255, 255, .02);
            position: sticky;
            top: 0;
            backdrop-filter: blur(6px);
            z-index: 2
        }

        header h1 {
            margin: 0;
            font-size: 1rem;
            letter-spacing: .2px
        }

        .spacer {
            flex: 1
        }

        .btn {
            background: #1d4ed8;
            color: #fff;
            border: none;
            padding: .55rem .9rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--stroke);
            color: var(--fg)
        }

        .btn.ghost.active {
            border-color: #1d4ed8;
            box-shadow: 0 0 0 2px rgba(29, 78, 216, .25) inset
        }

        .wrap {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--stroke);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25)
        }

        .card h2 {
            font-size: .95rem;
            font-weight: 600;
            margin: 0;
            padding: .8rem 1rem;
            border-bottom: 1px solid var(--stroke);
            color: var(--muted)
        }

        .body {
            padding: .75rem
        }

        .toolbar {
            display: flex;
            gap: .4rem;
            align-items: center;
            padding: .5rem .5rem .0rem;
            flex-wrap: wrap
        }

        .toolbar .sep {
            width: 1px;
            height: 28px;
            background: var(--stroke);
            margin: 0 .25rem
        }

        .toolbar .grow {
            flex: 1
        }

        #preview {
            padding: .5rem
        }

        #panzoom {
            position: relative;
            overflow: auto;
            border: 1px dashed var(--stroke);
            border-radius: 10px;
            background: rgba(255, 255, 255, .02);
            max-height: 76vh;
            cursor: grab;
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, .55) rgba(255, 255, 255, .06)
        }

        #panzoom.dragging {
            cursor: grabbing
        }

        #panzoom::-webkit-scrollbar {
            width: 12px;
            height: 12px
        }

        #panzoom::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, .06);
            border-radius: 8px
        }

        #panzoom::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, .45);
            border-radius: 8px;
            border: 2px solid transparent;
            background-clip: padding-box
        }

        #panzoom::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, .7)
        }

        #previewHost {
            position: relative
        }

        .mermaid svg {
            display: block
        }

        /* Hide ANY mermaid-rendered error artifacts inside the preview host */
        #previewHost .error,
        #previewHost .error-icon,
        #previewHost .error-text,
        #previewHost .messageText {
            display: none !important
        }

        /* Non-blocking error chip */
        #errorChip {
            position: absolute;
            top: 8px;
            right: 8px;
            max-width: min(520px, 60vw);
            pointer-events: none;
            background: var(--err-bg);
            border: 1px solid var(--err-border);
            color: var(--err-fg);
            padding: .45rem .6rem;
            border-radius: 10px;
            font-size: .85rem;
            line-height: 1.2;
            box-shadow: 0 8px 20px rgba(0, 0, 0, .25);
            display: none;
            z-index: 3
        }

        #status {
            font-size: .85rem;
            color: var(--muted)
        }

        @media (max-width:980px) {
            .wrap {
                padding: .75rem
            }
        }

        body[data-theme=light] {
            --bg: #f7fafc;
            --panel: #fff;
            --stroke: #e5e7eb;
            --fg: #0b1020;
            --muted: #4b5563;
            --err-bg: rgba(239, 68, 68, .08);
            --err-border: #fecaca;
            --err-fg: #7f1d1d
        }

        body[data-theme=light] #panzoom {
            scrollbar-color: rgba(100, 116, 139, .6) rgba(0, 0, 0, .05)
        }

        body[data-theme=light] #panzoom::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, .05)
        }

        body[data-theme=light] #panzoom::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, .55)
        }
    </style>
</head>

<body>
    <header>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="#93c5fd" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <h1>Mermaid Architecture Preview</h1>
        <div class="spacer"></div>
        <span id="status" aria-live="polite"></span>
        <button id="themeBtn" class="btn ghost" title="Toggle light/dark theme">Theme: Dark</button>
    </header>

    <div class="wrap">
        <div class="card">
            <h2>Preview</h2>
            <div class="toolbar">
                <span>Zoom:</span>
                <button id="zoomOut" class="btn ghost" title="Zoom out">−</button>
                <button id="zoomReset" class="btn ghost" title="Reset zoom">100%</button>
                <button id="zoomIn" class="btn ghost" title="Zoom in">+</button>
                <div class="sep"></div>
                <button id="fitWidth" class="btn ghost" title="Fit to width">Fit width</button>
                <button id="fitHeight" class="btn ghost" title="Fit to height">Fit height</button>
                <div class="grow"></div>
                <button id="reloadBtn" class="btn ghost" title="Force reload from diagram.mmd">Reload</button>
                <button id="exportSvgBtn" class="btn ghost" title="Export current SVG">Export SVG</button>
            </div>
            <div id="preview" class="body">
                <div id="panzoom">
                    <div id="previewHost" class="mermaid"></div>
                    <div id="errorChip"><span class="msg"></span></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

        const $ = (id) => document.getElementById(id);
        const previewHost = $('previewHost');
        const panzoom = $('panzoom');
        const statusEl = $('status');
        const themeBtn = $('themeBtn');
        const zoomInBtn = $('zoomIn');
        const zoomOutBtn = $('zoomOut');
        const zoomResetBtn = $('zoomReset');
        const fitWidthBtn = $('fitWidth');
        const fitHeightBtn = $('fitHeight');
        const reloadBtn = $('reloadBtn');
        const exportSvgBtn = $('exportSvgBtn');
        const errorChip = $('errorChip');
        const errorMsgEl = errorChip.querySelector('.msg');

        let baseW = 0, baseH = 0;
        let currentSVG = '';
        let lastGoodSVG = '';
        let lastDiagramText = null;
        let lastError = '';
        let zoom = 1;
        let fitMode = 'width'; // default to auto-fit width
        const loadedPacks = new Set();
        let pollTimer = null;

        const setStatus = (text) => {if (statusEl) statusEl.textContent = text || '';};
        const nowTime = () => new Date().toLocaleTimeString();

        function compressError(raw) {
            const s = String(raw || '');
            const first = s.split('\n').find(Boolean) || s;
            return first.replace(/\s*mermaid version\s*\d+(?:\.\d+)*\s*$/i, '').trim() || 'Invalid diagram.';
        }
        function showError(message) {
            const msg = compressError(message);
            if (msg === lastError) return;
            lastError = msg;
            errorMsgEl.textContent = `⚠️ ${msg}`;
            errorChip.style.display = 'block';
        }
        function clearError() {
            lastError = '';
            errorChip.style.display = 'none';
            errorMsgEl.textContent = '';
        }

        function parseViewBox(svgEl) {
            const vb = svgEl.getAttribute('viewBox'); if (!vb) return null;
            const p = vb.trim().split(/\s+/).map(Number);
            return p.length === 4 ? {w: p[2], h: p[3]} : null;
        }

        function applyZoomToSVG() {
            const svg = previewHost.querySelector('svg'); if (!svg || !baseW || !baseH) return;
            svg.removeAttribute('style'); svg.removeAttribute('width'); svg.removeAttribute('height');
            svg.setAttribute('width', String(Math.max(1, Math.round(baseW * zoom))));
            svg.setAttribute('height', String(Math.max(1, Math.round(baseH * zoom))));
            zoomResetBtn.textContent = `${Math.round(zoom * 100)}%`;
        }
        function computeFitZoom() {
            if (!baseW || !baseH) return;
            const cw = panzoom.clientWidth || baseW; const ch = panzoom.clientHeight || baseH;
            if (fitMode === 'width') zoom = cw / baseW; else if (fitMode === 'height') zoom = ch / baseH;
            zoom = Math.min(8, Math.max(0.1, zoom)); applyZoomToSVG();
        }
        function setFitMode(mode) {
            fitMode = mode;
            fitWidthBtn.classList.toggle('active', fitMode === 'width');
            fitHeightBtn.classList.toggle('active', fitMode === 'height');
            computeFitZoom();
        }

        async function registerPack(nameOrUrl) {
            if (loadedPacks.has(nameOrUrl)) return;
            const isUrl = /^(https?:)?\/\//i.test(nameOrUrl);
            let name = nameOrUrl, loader;
            if (isUrl) {
                loader = () => fetch(nameOrUrl).then(r => r.json());
                try {name = new URL(nameOrUrl, location.href).pathname.split('/').filter(Boolean).slice(-2, -1)[0] || nameOrUrl;} catch { }
            } else {
                loader = () => fetch(`https://unpkg.com/@iconify-json/${nameOrUrl}@1/icons.json`).then(r => r.json());
            }
            try {await mermaid.registerIconPacks([{name, loader}]); loadedPacks.add(nameOrUrl);}
            catch (e) {showError(`Icon pack failed: ${nameOrUrl}`);}
        }
        async function ensurePacks(list) {for (const t of list) await registerPack(t);}
        function detectPacksFromSource(src) {const re = /\b([a-z0-9-]+):[a-z0-9-]+\b/gi; const s = new Set(); let m; while ((m = re.exec(src))) s.add(m[1].toLowerCase()); return [...s];}

        async function renderFrom(text) {
            if (!text || !previewHost) return;
            try {
                const packs = detectPacksFromSource(text);
                await ensurePacks(packs);
                const id = 'arch' + Math.random().toString(36).slice(2);
                const {svg} = await mermaid.render(id, text);
                currentSVG = svg; lastGoodSVG = svg;
                previewHost.innerHTML = svg;

                const svgEl = previewHost.querySelector('svg');
                const vb = svgEl && parseViewBox(svgEl);
                if (vb) {baseW = vb.w; baseH = vb.h;} else {baseW = +svgEl.getAttribute('width') || 1200; baseH = +svgEl.getAttribute('height') || 800;}
                computeFitZoom();
                clearError();
                setStatus(`Updated ${nowTime()}`);
            } catch (e) {
                // Always replace preview with last good (or clear) to avoid Mermaid's error SVG/text.
                previewHost.innerHTML = lastGoodSVG || '';
                showError(e?.message || e);
            }
        }

        async function fetchDiagram() {
            try {
                const resp = await fetch('diagram.mmd?ts=' + Date.now(), {cache: 'no-store'});
                if (!resp.ok) return null;
                return (await resp.text()).replace(/\r\n?/g, '\n');
            } catch {return null;}
        }

        async function sync(initial = false) {
            const txt = await fetchDiagram(); if (txt == null) return;
            if (initial || lastDiagramText === null || txt !== lastDiagramText) {
                lastDiagramText = txt;
                await renderFrom(txt);
            }
        }

        function startPolling() {
            stopPolling();
            const tick = () => {if (!document.hidden) sync(false);};
            pollTimer = setInterval(tick, 800);
            document.addEventListener('visibilitychange', () => {if (!document.hidden) sync(false);});
        }
        function stopPolling() {if (pollTimer) clearInterval(pollTimer); pollTimer = null;}

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            themeBtn.textContent = `Theme: ${theme === 'dark' ? 'Dark' : 'Light'}`;
            const mTheme = theme === 'dark' ? 'dark' : 'default';
            mermaid.initialize({startOnLoad: false, theme: mTheme, securityLevel: 'strict'});
        }
        function toggleTheme() {
            const cur = document.body.getAttribute('data-theme') || 'dark';
            const next = cur === 'dark' ? 'light' : 'dark';
            applyTheme(next); renderFrom(lastDiagramText || '');
        }

        // Zoom & fit
        zoomInBtn.addEventListener('click', () => {fitMode = 'none'; zoom *= 1.2; applyZoomToSVG();});
        zoomOutBtn.addEventListener('click', () => {fitMode = 'none'; zoom /= 1.2; applyZoomToSVG();});
        zoomResetBtn.addEventListener('click', () => {fitMode = 'none'; zoom = 1; applyZoomToSVG();});
        fitWidthBtn.addEventListener('click', () => setFitMode(fitMode === 'width' ? 'none' : 'width'));
        fitHeightBtn.addEventListener('click', () => setFitMode(fitMode === 'height' ? 'none' : 'height'));
        panzoom.addEventListener('wheel', (e) => {if (e.ctrlKey || e.metaKey) {e.preventDefault(); const dir = e.deltaY > 0 ? -1 : 1; fitMode = 'none'; zoom *= dir > 0 ? 1.1 : (1 / 1.1); applyZoomToSVG();} }, {passive: false});

        // Drag to pan
        let isDragging = false, startX = 0, startY = 0, startL = 0, startT = 0;
        panzoom.addEventListener('mousedown', (e) => {isDragging = true; panzoom.classList.add('dragging'); startX = e.clientX; startY = e.clientY; startL = panzoom.scrollLeft; startT = panzoom.scrollTop;});
        window.addEventListener('mousemove', (e) => {if (!isDragging) return; panzoom.scrollLeft = startL - (e.clientX - startX); panzoom.scrollTop = startT - (e.clientY - startY);});
        window.addEventListener('mouseup', () => {isDragging = false; panzoom.classList.remove('dragging');});

        // Toolbar extras
        reloadBtn.addEventListener('click', () => sync(false));
        exportSvgBtn.addEventListener('click', async () => {
            try {
                const svgToSave = currentSVG || (await mermaid.render('tmp', lastDiagramText || '')).svg;
                const blob = new Blob([svgToSave], {type: 'image/svg+xml'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'diagram.svg'; a.click();
                setTimeout(() => URL.revokeObjectURL(a.href), 2000);
            } catch (e) {showError(e);}
        });

        // Auto-resize handling
        let resizeTimer = null;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {fitMode === 'none' ? applyZoomToSVG() : computeFitZoom();}, 80);
        });

        // Boot
        (async function boot() {
            applyTheme('dark');
            await sync(true);
            startPolling();
            // default to fit width for responsive behavior
            setFitMode('width');
        })();

        themeBtn.addEventListener('click', toggleTheme);
    </script>

    <noscript>
        <p style="padding:1rem;color:#fff;background:#7f1d1d">This page requires JavaScript to render Mermaid diagrams.
        </p>
    </noscript>
</body>

</html>
